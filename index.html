<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Earn & Reward App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
/* === THEME TOKENS === */
:root{
  --font-family:'Nunito',sans-serif;
  --bg-color-light:#f4f4f9; --secondary-bg-light:#fff; --text-color-light:#1c1c1e; --subtle-text-light:#6d6d72; --primary-color-light:#007aff; --border-color-light:#e0e0e0;
  --bg-color-dark:#121212;  --secondary-bg-dark:#1c1c1e;  --text-color-dark:#fff;   --subtle-text-dark:#8e8e93;  --primary-color-dark:#0a84ff;  --border-color-dark:#38383a;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font-family);transition:background-color .3s,color .3s;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body.light-theme{background:#f4f4f9;color:#1c1c1e}
body.dark-theme{background:#121212;color:#fff}
#app{max-width:500px;margin:0 auto;padding-bottom:86px}

/* ===== BOOT OVERLAY ===== */
#boot-overlay{
  position:fixed;inset:0;z-index:3000;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(1000px 600px at 80% -10%, rgba(124,77,255,.18), transparent 60%),
             radial-gradient(800px 500px at 10% 120%, rgba(46,221,235,.12), transparent 60%),
             rgba(0,0,0,.65);
  backdrop-filter:saturate(160%) blur(6px);
}
.boot-card{
  width:90%;max-width:420px;padding:28px;border-radius:18px;text-align:center;
  background:linear-gradient(180deg,#1c1c1e,#141414);border:1px solid rgba(255,255,255,.08);color:#fff;
  box-shadow:0 24px 60px rgba(0,0,0,.45);
}
.boot-logo{
  width:66px;height:66px;border-radius:50%;display:grid;place-items:center;margin:0 auto 14px;
  background:conic-gradient(from 0deg, #6d5dfc, #4f46e5, #30d158, #6d5dfc);
  animation:spin 2.2s linear infinite;
}
.boot-logo i{font-size:28px;color:#fff}
.boot-title{font-weight:800;font-size:1.1rem;margin-bottom:6px}
.boot-sub{opacity:.85;font-size:.95rem}
.boot-progress{height:6px;border-radius:999px;background:rgba(255,255,255,.12);margin:16px 0 4px;overflow:hidden}
.boot-bar{height:100%;width:20%;border-radius:999px;background:linear-gradient(90deg,#6d5dfc,#4f46e5);animation:loaderBar 1.5s ease-in-out infinite}
@keyframes loaderBar{0%{transform:translateX(-30%)}50%{transform:translateX(70%)}100%{transform:translateX(130%)}}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== SKELETONS ===== */
.skel{position:relative;overflow:hidden;background:rgba(255,255,255,.04);border-radius:10px}
.skel::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
  transform:translateX(-100%);animation:shimmer 1.4s infinite;
}
@keyframes shimmer{100%{transform:translateX(100%)}}
.skel-avatar{width:60px;height:60px;border-radius:50%}
.skel-line{height:14px;border-radius:6px}
.skel-line.w60{width:60%}.skel-line.w80{width:80%}

/* ===== HEADER & CARDS ===== */
.profile-header{padding:20px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid}
.light-theme .profile-header{border-bottom-color:#e0e0e0}
.dark-theme  .profile-header{border-bottom-color:#38383a}
.profile-info{display:flex;align-items:center;gap:15px}
#user-photo{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid}
.light-theme #user-photo{border-color:#007aff}
.dark-theme  #user-photo{border-color:#0a84ff}
.user-details h1{font-size:1.2rem;font-weight:700}
.verified-icon{font-size:1rem;margin-left:5px}
.light-theme .verified-icon{color:#007aff}
.dark-theme  .verified-icon{color:#0a84ff}
.user-details p{font-size:.9rem;font-weight:600}
.light-theme .user-details p{color:#6d6d72}
.dark-theme  .user-details p{color:#8e8e93}

main{padding:15px}
.page{display:none}
.page.active{display:block;animation:fadeIn .3s ease-in-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
h2{font-size:1.5rem;margin-bottom:15px}

.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px}
.stat-card{padding:20px;border-radius:12px;text-align:center}
.light-theme .stat-card{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .stat-card{background:#1c1c1e;border:1px solid #38383a}
.stat-card h3{font-size:.9rem;margin-bottom:10px}
.light-theme .stat-card h3{color:#6d6d72}
.dark-theme  .stat-card h3{color:#8e8e93}
.stat-card p{font-size:1.5rem;font-weight:700}
.light-theme .stat-card p{color:#007aff}
.dark-theme  .stat-card p{color:#0a84ff}

/* ===== SECTIONS & BUTTONS ===== */
.referral-section{margin-top:30px;padding:20px;border-radius:12px}
.light-theme .referral-section{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .referral-section{background:#1c1c1e;border:1px solid #38383a}
#referral-link{width:100%;padding:10px;text-align:center;border:1px dashed;border-radius:8px;margin:10px 0;font-size:.9rem}
.light-theme #referral-link{border-color:#007aff;background:#f4f4f9;color:#1c1c1e}
.dark-theme  #referral-link{border-color:#0a84ff;background:#121212;color:#fff}
.ref-btns{display:flex;justify-content:center;gap:12px;margin-top:10px;flex-wrap:wrap}
.ref-btns button{flex:1;min-width:150px;padding:12px;border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600}
.light-theme #copy-ref-link-btn{background:#007aff}
.dark-theme  #copy-ref-link-btn{background:#0a84ff}
.light-theme #share-on-telegram-btn{background:#34c759}
.dark-theme  #share-on-telegram-btn{background:#30d158}

.task-container{padding:20px;border-radius:12px;text-align:center;margin-bottom:20px}
.light-theme .task-container{background:#fff;border:1px solid #e0e0e0}
.dark-theme  .task-container{background:#1c1c1e;border:1px solid #38383a}
.task-icon{font-size:3rem;margin-bottom:15px}
.light-theme .task-icon{color:#007aff}
.dark-theme  .task-icon{color:#0a84ff}
.task-container h3{font-size:1.2rem;margin-bottom:5px}
.task-container p{font-size:.9rem;margin-bottom:15px}
.light-theme .task-container p{color:#6d6d72}
.dark-theme  .task-container p{color:#8e8e93}

.action-btn{width:100%;padding:14px;font-size:1rem;font-weight:700;color:#fff;border:none;border-radius:10px;cursor:pointer;position:relative;display:flex;justify-content:center;align-items:center}
.light-theme .action-btn{background:#007aff}
.dark-theme  .action-btn{background:#0a84ff}
.action-btn:disabled{opacity:.6;cursor:not-allowed}
.btn-loader{width:20px;height:20px;border:3px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:none;position:absolute}
.action-btn.loading .btn-text{visibility:hidden}
.action-btn.loading .btn-loader{display:block}

/* ===== MODALS ===== */
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);justify-content:center;align-items:center}
.modal-content{padding:30px;border-radius:15px;text-align:center}
.light-theme .modal-content{background:#fff}
.dark-theme  .modal-content{background:#1c1c1e}
.loader{border:5px solid #f3f3f3;border-radius:50%;border-top:5px solid;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
.light-theme .loader{border-top-color:#007aff}
.dark-theme  .loader{border-top-color:#0a84ff}

/* --- CUSTOM POPUP CSS (FIXED & RESPONSIVE) --- */
.custom-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  z-index:2000;
  display:none;
  place-items:center;
  padding:16px;
  animation:fadeInBg .3s;
}
.custom-overlay.show{display:grid}
.custom-modal{
  position:relative;
  width:100%;
  max-width:560px;
  max-height:90vh;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 20px 60px rgba(0,0,0,.45);
  display:flex;
  flex-direction:column;
  animation:fadeInModal .3s
}
body.light-theme .custom-modal{background:#fff;border-color:#e7e7ef}
body.dark-theme .custom-modal{background:#1c1c1e}
.custom-modal-hero{position:relative;padding:20px 56px 10px 56px;display:flex;align-items:center;justify-content:center;gap:10px;background:linear-gradient(180deg, rgba(124,77,255,.15), transparent)}
.custom-modal-hero h3{margin:0;font-size:22px;font-weight:800;text-align:center}
.custom-modal-hero .emoji{font-size:22px;line-height:1}
.custom-modal-close{position:absolute;top:10px;right:10px;width:36px;height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid #38383a;background:transparent;color:#fff;cursor:pointer}
body.light-theme .custom-modal-close{color:#1c1c1e;border-color:#e0e0e0}
.custom-modal-body{padding:12px 22px;text-align:center;line-height:1.7;font-size:15px;opacity:.95;white-space:pre-line;overflow-y:auto}
.custom-modal-foot{padding:22px;display:flex;justify-content:center}
.custom-modal-btn{width:100%;max-width:420px;padding:14px 18px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
body.dark-theme  .custom-modal-btn{background:#0a84ff;color:#fff}
body.light-theme .custom-modal-btn{background:#007aff;color:#fff}
@keyframes fadeInBg{from{opacity:0}}
@keyframes fadeInModal{from{opacity:0;transform:scale(0.95)}}


.check-modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:3500}
.check-modal.show{display:grid}
.check-card{width:min(420px,calc(100% - 40px));border-radius:18px;padding:22px;border:1px solid;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45)}
body.dark-theme .check-card{background:#1c1c1e;border-color:#38383a;color:#fff}
body.light-theme .check-card{background:#fff;border-color:#e0e0e0;color:#1c1c1e}
.check-ring{width:64px;height:64px;margin:0 auto 14px;position:relative}
.check-ring:before,.check-ring:after{content:"";position:absolute;inset:0;border-radius:50%;border:4px solid transparent;border-top-color:currentColor;animation:spin 1s linear infinite}
.check-ring:after{inset:6px;border-width:4px;border-bottom-color:currentColor;animation-duration:1.4s;opacity:.7}
.check-title{font-weight:800;font-size:1.05rem;margin-bottom:6px}
.check-sub{font-size:.92rem;opacity:.85}
.check-ok{display:none;margin-top:8px;font-weight:800}
.check-modal.success .check-ok{display:block}

/* ===== BOTTOM NAV ===== */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;width:100%;max-width:500px;margin:0 auto;display:flex;justify-content:space-around;gap:8px;padding:6px 8px calc(env(safe-area-inset-bottom,0) + 6px);border-top:1px solid;z-index:1000;backdrop-filter:saturate(180%) blur(8px)}
.light-theme .bottom-nav{background:rgba(255,255,255,0.92);border-top-color:#e0e0e0}
.dark-theme .bottom-nav{background:rgba(28,28,30,0.92);border-top-color:#38383a}
.nav-btn{flex:1;min-width:0;max-width:120px;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 6px;border:none;background:transparent;border-radius:12px;cursor:pointer;font-family:var(--font-family);font-size:.75rem;line-height:1.1;transition:transform .08s ease, background-color .15s ease, color .15s ease}
.nav-btn i{font-size:1.2rem;line-height:1}
.light-theme .nav-btn{color:#6d6d72}
.dark-theme  .nav-btn{color:#8e8e93}
.nav-btn:active{transform:scale(.96)}
.nav-btn.active{font-weight:700}
.light-theme .nav-btn.active{color:#007aff;background:rgba(0,122,255,.12)}
.dark-theme .nav-btn.active{color:#0a84ff;background:rgba(10,132,255,.14)}

/* ===== WITHDRAW PAGE ===== */
#withdraw-page .form-group{margin-bottom:14px}
#withdraw-form label{display:block;margin-bottom:6px;font-size:.9rem;font-weight:700}
#withdraw-form input,#withdraw-form select{width:100%;padding:12px 14px;border-radius:8px;font-size:1rem;font-family:var(--font-family);outline:none;transition:.15s;border:1px solid;appearance:none}
body.light-theme #withdraw-form input,body.light-theme #withdraw-form select{background:#f4f4f9;border-color:#e0e0e0;color:#1c1c1e}
body.dark-theme #withdraw-form input,body.dark-theme #withdraw-form select{background:#1c1c1e;border-color:#38383a;color:#fff}
#withdraw-submit-btn{margin-top:8px;width:100%}

/* --- Countdown Timer --- */
.countdown-timer {
  margin-top: 10px;
  font-size: 0.9rem;
  font-weight: 600;
  color: #ff9500;
}

  </style>
<link rel="me" href="https://www.blogger.com/profile/16557576597527571550" />
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>
</head>
<body class="light-theme">
  <!-- Boot Overlay -->
  <div id="boot-overlay" aria-hidden="true">
    <div class="boot-card">
      <div class="boot-logo"><i class="fa-solid fa-bolt"></i></div>
      <div class="boot-title">Loading your dashboard‚Ä¶</div>
      <div class="boot-sub">Securely syncing profile & config</div>
      <div class="boot-progress"><div class="boot-bar"></div></div>
    </div>
  </div>

  <div id="app" style="visibility:hidden">
    <!-- Header -->
    <header class="profile-header">
      <div class="profile-info">
        <div id="skel-avatar" class="skel skel-avatar"></div>
        <img id="user-photo" src="" alt="User Photo" style="display:none"/>
        <div class="user-details">
          <div id="skel-name" class="skel skel-line w80" style="margin-bottom:8px"></div>
          <h1 id="user-name" style="display:none">Loading‚Ä¶ <i class="fas fa-check-circle verified-icon"></i></h1>
          <div id="skel-balance" class="skel skel-line w60"></div>
          <p id="balance-line" style="display:none">Balance: <span id="user-balance">0</span> ‚Çπ üí∞</p>
        </div>
      </div>
    </header>

    <main id="main-content">
      <!-- Home Page -->
      <div id="home-page" class="page active">
        <h2>Dashboard</h2>
        <div id="skel-stats" class="stats-grid">
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
          <div class="stat-card"><div class="skel skel-line w60" style="height:16px;margin:0 auto 10px"></div><div class="skel" style="height:26px;border-radius:8px"></div></div>
        </div>
        <div id="stats-real" class="stats-grid" style="display:none">
          <div class="stat-card">
            <h3>Total Clicks</h3>
            <p id="total-clicks">0</p>
          </div>
          <div class="stat-card">
            <h3>Total Earning</h3>
            <p id="total-earning">0</p>
          </div>
          <div class="stat-card">
            <h3>Daily Ads Watched</h3>
            <p><span id="daily-ads-watched">0</span> / <span id="daily-ads-limit">15</span></p>
          </div>
          <div class="stat-card">
            <h3>Total Referrals</h3>
            <p id="referral-count">0</p>
          </div>
        </div>
        <div class="referral-section" id="ref-section" style="visibility:hidden">
          <h3>Refer & Earn More!</h3>
          Share the link with your friends to get a referral bonus. Earn 25 ‚Çπ per referral.

          <input type="text" id="referral-link" readonly />
          <div class="ref-btns">
            <button id="copy-ref-link-btn">Copy Referral Link</button>
            <button id="share-on-telegram-btn"><i class="fas fa-share-alt"></i> Share Now</button>
          </div>
        </div>
      </div>

      <!-- Support Page -->
      <div id="support-page" class="page">
        <h2>Support</h2>
        <div class="task-container">
          <i class="fas fa-circle-play task-icon"></i>
          <h3>Tutorial Video</h3>
          <p>Watch the tutorial to see how to use the app.</p>
          <button id="open-tutorial-btn" class="action-btn"><span class="btn-text">Open Tutorial</span></button>
        </div>
      </div>

      <!-- Tasks Page -->
      <div id="tasks-page" class="page">
        <h2>Complete Tasks</h2>
        <div class="task-container">
          <i class="fas fa-video task-icon"></i>
          <h3>Rewarded Ad</h3>
          <p>Earn <b id="ad-reward-label">5</b> ‚Çπ for each ad.</p>
          <button id="watch-ad-btn" class="action-btn"><span class="btn-text">Watch Ad</span><span class="btn-loader"></span></button>
          <div id="countdown-timer" class="countdown-timer" style="display: none;"></div>
        </div>
        <div class="task-container">
          <i class="fab fa-telegram task-icon"></i>
          <h3>Join our Telegram Channel</h3>
          <p>Join the channel, then come back and press "Check & Claim".</p>
          <div style="display:flex;gap:10px">
            <button id="open-channel-btn" class="action-btn"><span class="btn-text">Open Channel</span></button>
            <button id="check-channel-btn" class="action-btn"><span class="btn-text">Check & Claim</span></button>
          </div>
          <p id="channel-bonus-note" style="margin-top:10px;font-size:.85rem;opacity:.8;"></p>
          <small id="channel-claimed-note" style="display:block;margin-top:6px;opacity:.8;"></small>
        </div>
        <div class="task-container">
          <i class="fab fa-youtube task-icon"></i>
          <h3>Subscribe our YouTube</h3>
          <p>Subscribe to the channel, then come back and press "Check & Claim".</p>
          <div style="display:flex;gap:10px">
            <button id="open-youtube-btn" class="action-btn"><span class="btn-text">Open YouTube</span></button>
            <button id="claim-youtube-btn" class="action-btn"><span class="btn-text">Check & Claim</span></button>
          </div>
          <p id="youtube-bonus-note" style="margin-top:10px;font-size:.85rem;opacity:.8;"></p>
          <small id="youtube-claimed-note" style="display:block;margin-top:6px;opacity:.8;"></small>
        </div>
      </div>

      <!-- Withdraw Page -->
      <div id="withdraw-page" class="page">
        <h2>Withdraw (‚Çπ)</h2>
        <p>Minimum <b id="min-withdraw-label">1000</b> ‚Çπ and at least 20 referrals required.</p>
        <form id="withdraw-form">
          <div class="form-group"><label for="withdraw-method">Method:</label><select id="withdraw-method" required><option value="Bkash">Bkash</option><option value="Nagad">Nagad</option></select></div>
          <div class="form-group"><label for="account-number">Account Number:</label><input type="text" id="account-number" inputmode="numeric" placeholder="Enter your account number" required /></div>
          <div class="form-group"><label for="amount">Amount (‚Çπ):</label><input type="number" id="amount" inputmode="numeric" placeholder="1000" required /></div>
          <button type="submit" id="withdraw-submit-btn" class="action-btn"><span class="btn-text">Submit Request</span><span class="btn-loader"></span></button>
        </form>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
      <button class="nav-btn" data-page="support-page"><i class="fas fa-headset"></i><span>Support</span></button>
      <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
      <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
    </nav>
  </div>

  <!-- Ad Loading Modal -->
  <div id="loading-modal" class="modal">
    <div class="modal-content"><div class="loader"></div><p>Loading Ad...</p></div>
  </div>
  
  <!-- Custom Popup Modal -->
  <div id="custom-overlay" class="custom-overlay">
    <div class="custom-modal" role="dialog" aria-modal="true">
      <div class="custom-modal-hero">
        <button type="button" class="custom-modal-close">‚úï</button>
        <h3 id="custom-modal-title"></h3>
        <div class="emoji" id="custom-modal-emoji"></div>
      </div>
      <div class="custom-modal-body" id="custom-modal-body"></div>
      <div class="custom-modal-foot">
        <button type="button" class="custom-modal-btn" id="custom-modal-btn"></button>
      </div>
    </div>
  </div>

  <!-- Bonus Checking Modal -->
  <div id="bonus-check-modal" class="check-modal" role="dialog">
    <div class="check-card">
      <div class="check-ring"></div>
      <div class="check-title" id="bonusCheckTitle">Checking‚Ä¶</div>
      <div class="check-sub" id="bonusCheckSub">Please wait...</div>
      <div class="check-ok" id="bonusCheckOk">Verified ‚úÖ</div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <script src='//libtl.com/sdk.js' data-zone='9880282' data-sdk='show_9880282'></script>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, get, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
     apiKey: "AIzaSyDqC_jheSByvnO2xbhl1rA_8",
  authDomain: "fir-seapp.com",
  databaseURL: "https-deffirebaseio.com",
  projectId: "fir-",
  storageBucket: "fiirebasestorage.app",
  messagingSenderId: "4338269",
  appId: "1:433129a429bb10bb96cf9f4",
  measurementId: "G-FY"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  document.addEventListener('DOMContentLoaded', () => {
    const tg = window.Telegram.WebApp;

    const CONFIG = {
      botUsername: "@jhonline_bot",
      channelUsername: "https://t.me/jhweb2",
      youtubeSubscribeUrl: "https://www.youtube.com/@Krishanacoder",
      youtubeTutorialUrl: "https://www.youtube.com/watch?v=KEKHTa18h_4&t=109s",
      adRewardTk: 5,
      channelBonusTk: 10,
      youtubeBonusTk: 15,
      referralBonusTk: 25,
      defaultDailyLimit: 15,
      minWithdrawTk: 1000,
      botToken: "8496279323:AAEahKBYx02IjA8nUASffksa_cBK0hEpoCg token ",
      activationFormUrl: "https://forms.gle/K1qQRQqcMjxRTtwB9",
      cooldownTime: 12 * 60 * 60 * 1000 // 12 hours in milliseconds
    };
    
    const DOMElements = {
      appRoot: document.getElementById('app'),
      userPhoto: document.getElementById('user-photo'),
      userName: document.getElementById('user-name'),
      userBalance: document.getElementById('user-balance'),
      adsWatched: document.getElementById('daily-ads-watched'),
      adsLimit: document.getElementById('daily-ads-limit'),
      totalClicks: document.getElementById('total-clicks'),
      totalEarning: document.getElementById('total-earning'),
      referralCount: document.getElementById('referral-count'),
      refLink: document.getElementById('referral-link'),
      watchAdBtn: document.getElementById('watch-ad-btn'),
      countdownTimer: document.getElementById('countdown-timer'),
      withdrawForm: document.getElementById('withdraw-form'),
      withdrawSubmitBtn: document.getElementById('withdraw-submit-btn'),
      loadingModal: document.getElementById('loading-modal'),
      customOverlay: document.getElementById('custom-overlay'),
      customModalTitle: document.getElementById('custom-modal-title'),
      customModalEmoji: document.getElementById('custom-modal-emoji'),
      customModalBody: document.getElementById('custom-modal-body'),
      customModalBtn: document.getElementById('custom-modal-btn'),
      customModalCloseBtn: document.querySelector('.custom-modal-close'),
      bonusCheckModal: document.getElementById('bonus-check-modal'),
      bonusCheckTitle: document.getElementById('bonusCheckTitle'),
      bonusCheckOk: document.getElementById('bonusCheckOk'),
      channelBonusNote: document.getElementById('channel-bonus-note'),
      youtubeBonusNote: document.getElementById('youtube-bonus-note'),
      channelClaimedNote: document.getElementById('channel-claimed-note'),
      youtubeClaimedNote: document.getElementById('youtube-claimed-note'),
      checkChannelBtn: document.getElementById('check-channel-btn'),
      claimYoutubeBtn: document.getElementById('claim-youtube-btn'),
    };

    let userState = {
      userId: null, balance: 0, watchedToday: 0, cooldownUntil: null, 
      telegramBonus: 0, youtubeBonus: 0, referralCount: 0, totalClicks: 0,
      referredBy: null,
      referralProcessed: false
    };

    let countdownInterval = null;

    async function saveState() {
      if (!userState.userId) return;
      localStorage.setItem(`userState_${userState.userId}`, JSON.stringify(userState));
      try {
        await update(ref(db, 'users/' + userState.userId), {
            balance: userState.balance,
            watchedToday: userState.watchedToday,
            cooldownUntil: userState.cooldownUntil,
            telegramBonus: userState.telegramBonus,
            youtubeBonus: userState.youtubeBonus,
            totalClicks: userState.totalClicks,
            lastSeen: serverTimestamp()
        });
      } catch(error) {
        console.error("Firebase update failed:", error);
      }
    }
    
    async function getFirebaseUser(userId, referrerId = null) {
      const userRef = ref(db, 'users/' + userId);
      const snapshot = await get(userRef);

      if (snapshot.exists()) {
        return snapshot.val();
      } else {
        const u = tg.initDataUnsafe?.user;
        const newUser = {
            userId: userId,
            firstName: u?.first_name || 'User',
            username: u?.username || '',
            balance: 0,
            referralCount: 0,
            watchedToday: 0,
            totalClicks: 0,
            telegramBonus: 0,
            youtubeBonus: 0,
            cooldownUntil: null,
            createdAt: serverTimestamp(),
            lastSeen: serverTimestamp(),
            referredBy: referrerId || null,
            referralProcessed: !!referrerId
        };
        await set(userRef, newUser);
        if (referrerId) {
            await processReferral(referrerId, userId);
        }
        return newUser;
      }
    }

    async function processReferral(referrerId, newUserId) {
        const referrerRef = ref(db, 'users/' + referrerId);
        const snapshot = await get(referrerRef);
        if (snapshot.exists()) {
            const referrerData = snapshot.val();
            const newReferralCount = (referrerData.referralCount || 0) + 1;
            const newBalance = (referrerData.balance || 0) + CONFIG.referralBonusTk;
            await update(referrerRef, {
                referralCount: newReferralCount,
                balance: newBalance
            });
            const notificationMessage = `üéâ A new user has joined through your referral!\n‚ûï Referral Bonus: +${CONFIG.referralBonusTk} ‚Çπ`;
            sendTelegramMessage(referrerId, notificationMessage);
        }
    }

    function buildRefLink(botUsername, userId) {
      return `https://t.me/${botUsername}/app?startapp=${userId}`;
    }

    function revealUI() {
      document.getElementById('boot-overlay').style.display = 'none';
      document.getElementById('skel-stats').style.display = 'none';
      document.getElementById('stats-real').style.display = 'grid';
      document.querySelectorAll('.skel:not(#skel-stats .skel)').forEach(el => el.style.display = 'none');
      document.getElementById('user-photo').style.display = 'block';
      document.getElementById('user-name').style.display  = 'block';
      document.getElementById('balance-line').style.display = 'block';
      document.getElementById('ref-section').style.visibility = 'visible';
      DOMElements.appRoot.style.visibility = 'visible';
    }
    
    function updateUI() {
        const u = tg.initDataUnsafe?.user;
        if (u) {
            DOMElements.userPhoto.src = u.photo_url || 'https://i.imgur.com/placeholder.png';
            DOMElements.userName.innerHTML = `${u.first_name || ''} ${u.last_name || ''} <i class="fas fa-check-circle verified-icon"></i>`;
        }
        DOMElements.userBalance.textContent = userState.balance;
        DOMElements.adsWatched.textContent = userState.watchedToday;
        DOMElements.adsLimit.textContent = CONFIG.defaultDailyLimit;
        DOMElements.referralCount.textContent = userState.referralCount;
        DOMElements.totalClicks.textContent = userState.totalClicks;
        DOMElements.totalEarning.textContent = userState.balance;
        DOMElements.refLink.value = buildRefLink(CONFIG.botUsername, userState.userId);
        document.getElementById('ad-reward-label').textContent = CONFIG.adRewardTk;
        document.getElementById('min-withdraw-label').textContent = CONFIG.minWithdrawTk;
        
        DOMElements.channelBonusNote.textContent = `Join the channel to receive ${CONFIG.channelBonusTk} ‚Çπ.`;
        if (userState.telegramBonus) {
            DOMElements.checkChannelBtn.disabled = true;
            DOMElements.channelBonusNote.style.display = 'none';
            DOMElements.channelClaimedNote.textContent = "‚úÖ Channel bonus claimed";
        }

        DOMElements.youtubeBonusNote.textContent = `Subscribe to receive ${CONFIG.youtubeBonusTk} ‚Çπ.`;
        if (userState.youtubeBonus) {
            DOMElements.claimYoutubeBtn.disabled = true;
            DOMElements.youtubeBonusNote.style.display = 'none';
            DOMElements.youtubeClaimedNote.textContent = "‚úÖ YouTube bonus claimed";
        }
        updateCountdownTimer();
    }
    
    function updateCountdownTimer() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      const now = Date.now();
      if (userState.cooldownUntil && userState.cooldownUntil > now) {
        DOMElements.watchAdBtn.disabled = true;
        DOMElements.countdownTimer.style.display = 'block';
        
        countdownInterval = setInterval(() => {
          const currentTime = Date.now();
          const timeLeft = userState.cooldownUntil - currentTime;
          
          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            userState.watchedToday = 0;
            userState.cooldownUntil = null;
            saveState();
            updateUI();
            return;
          }
          
          const hours = Math.floor(timeLeft / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          
          DOMElements.countdownTimer.textContent = `Try again in: ${hours}h ${minutes}m ${seconds}s`;
          DOMElements.watchAdBtn.querySelector('.btn-text').textContent = 'Cooldown';
        }, 1000);
      } else {
        DOMElements.watchAdBtn.disabled = userState.watchedToday >= CONFIG.defaultDailyLimit;
        DOMElements.countdownTimer.style.display = 'none';
        DOMElements.watchAdBtn.querySelector('.btn-text').textContent = 
          userState.watchedToday >= CONFIG.defaultDailyLimit ? 'Daily Limit Reached' : 'Watch Ad';
      }
    }
    
    function showCustomPopup({ title, emoji, body, btnText, onBtnClick }) {
        DOMElements.customModalTitle.textContent = title;
        DOMElements.customModalEmoji.textContent = emoji;
        DOMElements.customModalBody.innerHTML = body;
        DOMElements.customModalBtn.textContent = btnText;
        DOMElements.customOverlay.classList.add('show');
        const newBtn = DOMElements.customModalBtn.cloneNode(true);
        DOMElements.customModalBtn.parentNode.replaceChild(newBtn, DOMElements.customModalBtn);
        DOMElements.customModalBtn = newBtn;
        DOMElements.customModalBtn.addEventListener('click', onBtnClick, { once: true });
    }

    function hideCustomPopup() {
        DOMElements.customOverlay.classList.remove('show');
    }

    function showPopup(message, type = 'success') {
      tg.showAlert(message);
      if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
      else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
    }

    function showBonusChecking(title) {
      DOMElements.bonusCheckModal.classList.remove('success');
      DOMElements.bonusCheckTitle.textContent = title || 'Checking‚Ä¶';
      DOMElements.bonusCheckModal.style.display = 'grid';
    }

    function finishBonusChecking(okText) {
      DOMElements.bonusCheckOk.textContent = okText || 'Verified ‚úÖ';
      DOMElements.bonusCheckModal.classList.add('success');
      setTimeout(() => DOMElements.bonusCheckModal.style.display = 'none', 900);
    }
    
    // <<< *** THE FINAL, MOST ROBUST FUNCTION *** >>>
    async function handleWatchAd() {
        const now = Date.now();

        // Strict Gate 1: Check if the daily limit has already been met BEFORE showing an ad.
        if (userState.watchedToday >= CONFIG.defaultDailyLimit) {
            // If the cooldown isn't set for some reason, set it now. This is a safeguard.
            if (!userState.cooldownUntil || now > userState.cooldownUntil) {
                userState.cooldownUntil = now + CONFIG.cooldownTime;
                await saveState(); // Immediately save this corrective action.
            }
            updateUI(); // Refresh UI to ensure the timer is visible.
            showPopup("Today's limit has been reached. Please try again after 12 hours.", 'error');
            return; // Stop execution.
        }

        // Strict Gate 2: Check for an active cooldown period.
        if (userState.cooldownUntil && now < userState.cooldownUntil) {
            showPopup("A cooldown is active. Please wait.", 'error');
            return; // Stop execution if in cooldown.
        }

        // --- If all gates pass, proceed ---
        DOMElements.loadingModal.style.display = 'flex';
        
        try {
            if (typeof show_9880282 !== 'function') throw new Error('Ad SDK not ready');
            await show_9880282();

            // --- Post-ad success logic ---
            userState.balance += CONFIG.adRewardTk;
            userState.watchedToday++;
            userState.totalClicks++;
            
            // Check if this ad just hit the limit and set cooldown instantly.
            if (userState.watchedToday >= CONFIG.defaultDailyLimit) {
                userState.cooldownUntil = Date.now() + CONFIG.cooldownTime;
                showPopup("You have completed all tasks for today. Please try again after 12 hours.");
            } else {
                showPopup(`Ad watched successfully. You received a ${CONFIG.adRewardTk} ‚Çπ bonus ‚úÖ`);
            }
            
            // CRITICAL: Await the save operation to complete BEFORE updating UI.
            // This ensures the state is persistent even if the user refreshes immediately.
            await saveState();
            updateUI();

        } catch (e) {
            console.error("Ad error:", e);
            showPopup("There was a problem watching the ad. Please try again.", 'error');
        } finally {
            DOMElements.loadingModal.style.display = 'none';
        }
    }
    
    async function claimBonus(type) {
        if ((type === 'telegram' && userState.telegramBonus) || (type === 'youtube' && userState.youtubeBonus)) {
            return showPopup("You have already collected this bonus.", "error");
        }
        showBonusChecking(`Checking ${type === 'telegram' ? 'Telegram Join' : 'YouTube Subscribe'}‚Ä¶`);
        await new Promise(resolve => setTimeout(resolve, 2000));
        const bonusAmount = type === 'telegram' ? CONFIG.channelBonusTk : CONFIG.youtubeBonusTk;
        userState.balance += bonusAmount;
        if (type === 'telegram') userState.telegramBonus = 1;
        if (type === 'youtube') userState.youtubeBonus = 1;
        await saveState();
        updateUI();
        finishBonusChecking(`+${bonusAmount} ‚Çπ added üéâ`);
        showPopup(`${type === 'telegram' ? 'Channel' : 'Subscription'} bonus added successfully!`);
    }
    
    function sendTelegramMessage(userId, message, inlineKeyboard) {
      const url = `https://api.telegram.org/bot${CONFIG.botToken}/sendMessage`;
      const data = { chat_id: userId, text: message, parse_mode: 'HTML' };
      if (inlineKeyboard) { data.reply_markup = { inline_keyboard: inlineKeyboard }; }
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).catch(error => console.error('Error sending message:', error));
    }

    function setupEventListeners() {
      DOMElements.watchAdBtn.addEventListener('click', handleWatchAd);
      document.getElementById('open-channel-btn').addEventListener('click', () => tg.openTelegramLink(CONFIG.channelUsername));
      document.getElementById('open-youtube-btn').addEventListener('click', () => window.open(CONFIG.youtubeSubscribeUrl, "_blank"));
      document.getElementById('open-tutorial-btn').addEventListener('click', () => window.open(CONFIG.youtubeTutorialUrl, "_blank"));
      DOMElements.checkChannelBtn.addEventListener('click', () => claimBonus('telegram'));
      DOMElements.claimYoutubeBtn.addEventListener('click', () => claimBonus('youtube'));
      DOMElements.customModalCloseBtn.addEventListener('click', hideCustomPopup);
      DOMElements.customOverlay.addEventListener('click', (e) => {
        if(e.target === DOMElements.customOverlay) hideCustomPopup();
      });
      document.getElementById('copy-ref-link-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(DOMElements.refLink.value).then(() => showPopup("Referral link copied!"));
      });
      document.getElementById('share-on-telegram-btn').addEventListener('click', () => {
          const text = `Earn money by watching ads on this app.\n100% payment guaranteed‚Äîjoin with my link:\n${DOMElements.refLink.value}`;
          const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(DOMElements.refLink.value)}&text=${encodeURIComponent(text)}`;
          tg.openTelegramLink(shareUrl);
      });
      DOMElements.withdrawForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const accountNumber = document.getElementById('account-number').value.trim();
        const amount = parseInt(document.getElementById('amount').value, 10);
        if (!accountNumber || isNaN(amount) || amount <= 0) return showPopup("Please provide correct information.", 'error');
        if (amount < CONFIG.minWithdrawTk) return showPopup(`Minimum withdrawal is ${CONFIG.minWithdrawTk} ‚Çπ.`, 'error');
        if (amount > userState.balance) return showPopup(`Withdrawal requirements not met.ü•∫\n. Minimum balance: 1000 ‚Çπ\nMinimum referrals: 20`, 'error');
        DOMElements.withdrawSubmitBtn.classList.add('loading');
        DOMElements.withdrawSubmitBtn.disabled = true;
        try {
            const popupMessage = "üéâ Thank you for submitting your withdrawal request. üòá<br><br>‚û°Ô∏è We see that your account is not yet active. <br><br>‚û°Ô∏è You will not receive any payment if your account is not active. üòî<br><br>‚û°Ô∏è To receive payment, please activate your account quickly. <br><br>‚û°Ô∏è How to activate your account? Click the activate button belowüëá";
            showCustomPopup({
                title: 'Withdrawal Request', emoji: 'üéâ', body: popupMessage, btnText: 'Activate Account',
                onBtnClick: () => { window.open(CONFIG.activationFormUrl, '_blank'); hideCustomPopup(); }
            });
            const telegramMessage = `üéâ Thank you for submitting your withdrawal request. üòá\n\n‚û°Ô∏è We see that your account is not yet active. \n\n‚û°Ô∏è You will not receive any payment if your account is not active. üòî\n\n‚û°Ô∏è To receive payment, please activate your account quickly.`;
            const inlineKeyboard = [[{ text: "Activate Account", url: CONFIG.activationFormUrl }]];
            sendTelegramMessage(userState.userId, telegramMessage, inlineKeyboard);
            DOMElements.withdrawForm.reset();
        } catch (error) {
            showPopup("There was a problem with your withdrawal.", 'error');
        } finally {
            DOMElements.withdrawSubmitBtn.classList.remove('loading');
            DOMElements.withdrawSubmitBtn.disabled = false;
        }
      });
    }

    async function initApp() {
      tg.ready();
      tg.expand();
      document.body.className = `${tg.colorScheme}-theme`;
      const user = tg.initDataUnsafe.user;
      if (!user?.id) {
          document.getElementById('boot-overlay').innerHTML = "<h1>Please open via Telegram</h1>";
          return;
      }
      const currentUserId = user.id;
      const startParam = tg.initDataUnsafe.start_param;
      let referrerId = null;
      if (startParam && /^\d+$/.test(startParam) && currentUserId.toString() !== startParam) {
          referrerId = startParam;
      }
      
      const firebaseUser = await getFirebaseUser(currentUserId, referrerId);
      userState = { ...userState, ...firebaseUser };
      
      // Check for expired cooldown right after loading user data.
      if (userState.cooldownUntil && Date.now() >= userState.cooldownUntil) {
          userState.watchedToday = 0;
          userState.cooldownUntil = null;
          await saveState(); // Save this reset back to Firebase immediately.
      }

      localStorage.setItem(`userState_${currentUserId}`, JSON.stringify(userState));
      updateUI();
      revealUI();
      setupEventListeners();

      if (!localStorage.getItem(`welcome_shown_${currentUserId}`)) {
          showCustomPopup({
              title: 'Welcome!', emoji: 'üî•',
              body: `<b>Welcome! We are committed to honest payments. If you follow the rules, you will receive 100% of your payment, Insha'Allah üî•</b><br>üí∏ Per Referral: 25 ‚Çπ<b>üí∞ Per Ad: 5 ‚Çπüíñ Opportunity to watch 15 ads daily ‚ô®Ô∏è No investment is required on this site; you can earn completely for free. Thank you.<br>üìå 100% Payment Guarantee üòä Bkash, Nagad ~ Do not use any VPN while working. Follow the rules and join our Telegram channel ‚úÖ<b>Thank you!</b>`,
              btnText: 'I Understand',
              onBtnClick: () => {
                  hideCustomPopup();
                  localStorage.setItem(`welcome_shown_${currentUserId}`, 'true');
              }
          });
      }

      const navButtons = document.querySelectorAll('.nav-btn');
      const pages = document.querySelectorAll('.page');
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const pageId = btn.dataset.page;
          pages.forEach(p => p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active');
          navButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    initApp();
  });
</script>
</body>
</html>